<html>
<head>
    <title>WebGL</title>
    <meta charset="utf-8" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #controlPanel {
            width: 20%;
            background-color: rgba(255, 0, 0,0.5);
            display: none;
            right: 0;
            position: fixed;
        }

        .animations {
            margin: 5px;
            border: 1px solid black;
            display: inline-block;
        }
    </style>
    <script src="libs/jquery-3.1.1.js"></script>
    <script src="libs/three.js"></script>
	<script src="js/RayCaster.js"></script>

    <script>
        
		var player;
		var direction = {
			x: 0,
			y: 0,
			z: 0
		}
		var isMoving = true;
		var speed = 0.5;
		var move_axis = 1; // 0 - x, 1 - z
		
        window.addEventListener("load", function () {

            document.getElementById("controlPanel").style.height = window.innerHeight

            var width = window.innerWidth;
            var height = window.innerHeight;

                var scene = new THREE.Scene();
                
                var camera = new THREE.OrthographicCamera(width / - 6, width / 6, height / 6, height / - 6, 1, 1000);

                var renderer = new THREE.WebGLRenderer({ antialias: true });

                renderer.shadowMapEnabled = true
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                var container = new THREE.Object3D();


                var geo = new THREE.CubeGeometry(50, 50, 50);
				var geo2 = new THREE.CubeGeometry(10, 10, 10);
                var material = new THREE.MeshBasicMaterial({
                    color: 0xffffff, side: THREE.DoubleSide, map: THREE.ImageUtils.loadTexture("dirt.png")
                })
				var material2 = new THREE.MeshBasicMaterial({
                    color: 0xffffff, side: THREE.DoubleSide, map: THREE.ImageUtils.loadTexture("grass.png")
                })
                var Mesh = new THREE.Mesh(geo, material);
				var GrassMesh = new THREE.Mesh(geo2, material2);
                container.add(Mesh);

                var lineMaterial = new THREE.LineBasicMaterial({ color: 0xffffff });
                var geometry = new THREE.Geometry();
                geometry.vertices.push(new THREE.Vector3(-25, -25, -25))
                geometry.vertices.push(new THREE.Vector3(-25, 25, -25))
                geometry.vertices.push(new THREE.Vector3(-25, 25, 25))
                geometry.vertices.push(new THREE.Vector3(-25, -25, 25))
                geometry.vertices.push(new THREE.Vector3(-25, -25, -25))

                geometry.vertices.push(new THREE.Vector3(25, -25, -25))
                geometry.vertices.push(new THREE.Vector3(25, 25, -25))
                geometry.vertices.push(new THREE.Vector3(-25, 25, -25))
                geometry.vertices.push(new THREE.Vector3(-25, -25, -25))

                geometry.vertices.push(new THREE.Vector3(25, -25, -25))
                geometry.vertices.push(new THREE.Vector3(25, -25, 25))
                geometry.vertices.push(new THREE.Vector3(25, 25, 25))
                geometry.vertices.push(new THREE.Vector3(25, 25, -25))
                geometry.vertices.push(new THREE.Vector3(25, -25, -25))

                geometry.vertices.push(new THREE.Vector3(25, -25, 25))
                geometry.vertices.push(new THREE.Vector3(-25, -25, 25))
                geometry.vertices.push(new THREE.Vector3(-25, 25, 25))
                geometry.vertices.push(new THREE.Vector3(25, 25, 25))
				
				var geometry2 = new THREE.Geometry();
                geometry2.vertices.push(new THREE.Vector3(-5, -5, -5))
                geometry2.vertices.push(new THREE.Vector3(-5, 5, -5))
                geometry2.vertices.push(new THREE.Vector3(-5, 5, 5))
                geometry2.vertices.push(new THREE.Vector3(-5, -5, 5))
                geometry2.vertices.push(new THREE.Vector3(-5, -5, -5))

                geometry2.vertices.push(new THREE.Vector3(5, -5, -5))
                geometry2.vertices.push(new THREE.Vector3(5, 5, -5))
                geometry2.vertices.push(new THREE.Vector3(-5, 5, -5))
                geometry2.vertices.push(new THREE.Vector3(-5, -5, -5))

                geometry2.vertices.push(new THREE.Vector3(5, -5, -5))
                geometry2.vertices.push(new THREE.Vector3(5, -5, 5))
                geometry2.vertices.push(new THREE.Vector3(5, 5, 5))
                geometry2.vertices.push(new THREE.Vector3(5, 5, -5))
                geometry2.vertices.push(new THREE.Vector3(5, -5, -5))

                geometry2.vertices.push(new THREE.Vector3(5, -5, 5))
                geometry2.vertices.push(new THREE.Vector3(-5, -5, 5))
                geometry2.vertices.push(new THREE.Vector3(-5, 5, 5))
                geometry2.vertices.push(new THREE.Vector3(5, 5, 5))

                var line = new THREE.Line(geometry, lineMaterial);
				var line2 = new THREE.Line(geometry2, lineMaterial);

                container.add(line)
				var container2 = container.clone();
				container2.position.x = 50;
				container2.position.z = 150;
				
				var container3 = new THREE.Object3D();
				container3.add(GrassMesh);
				container3.add(line2);
				
				var table = []
				
				table.push(container);
				table.push(container2);
				
				player = container3.clone();
				player.position.x = 50;
				player.position.z = 150;
				player.position.y = 25 +5;
				scene.add(player);
                scene.add(container)
				scene.add(container2)
                renderer.setClearColor(0x000000);
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById("main").appendChild(renderer.domElement);

                camera.position.x = -300
                camera.position.y = 0
                camera.position.z = 0
var rotation = 0;
var c=0;
				function changecamera(){
					switch(c)
					{
						case 0:
						camera.position.x = -300
							camera.position.y = 0
							camera.position.z = 0
						break;
						case 1:
						camera.position.x = 0
							camera.position.y = 0
							camera.position.z = 300
						
						break;
						case 2:
						camera.position.x = 300
							camera.position.y = 0
							camera.position.z = 0
						
						break;
						case 3:
						camera.position.x = 0
							camera.position.y = 0
							camera.position.z = -300
						
						break;
					}
				}
				var tmo;
				function rotateLeft(){
				if(move_axis >=3) move_axis=0;
				else move_axis++
				if((move_axis==0||move_axis==3) && speed >0) speed *= -1;
				if((move_axis==2||move_axis==1) && speed <0) speed *= -1;
				var it = 0;
				console.log(move_axis, speed)
				tmo = setInterval(function(){
								++it;
								var tempZ = camera.position.z * Math.cos(Math.PI/180) - camera.position.x * Math.sin(Math.PI/180)
								var tempX = camera.position.z * Math.sin(Math.PI/180) + camera.position.x * Math.cos(Math.PI/180)
								camera.position.x = tempX;
								camera.position.z = tempZ;
								if(it >=90) clearInterval(tmo);
							}, 1);
				}
				function rotateRight(){
				if(move_axis <=0) move_axis=3;
				else move_axis--
				if((move_axis==0||move_axis==3) && speed >0) speed *= -1;
				if((move_axis==2||move_axis==1) && speed <0) speed *= -1;
				var it = 0;
				
				console.log(move_axis, speed)
				tmo = setInterval(function(){
								++it;
								var tempZ = camera.position.z * Math.cos(-Math.PI/180) - camera.position.x * Math.sin(-Math.PI/180)
								var tempX = camera.position.z * Math.sin(-Math.PI/180) + camera.position.x * Math.cos(-Math.PI/180)
								camera.position.x = tempX;
								camera.position.z = tempZ;
								if(it >=90) clearInterval(tmo);
							}, 1);
				}
				document.addEventListener("keydown",function(e){
				//console.log(e.which)
					switch(e.which)
					{
						
						case 65: // A - move left
								if(move_axis%2==0)
									direction.x = -1;
								else
									direction.z = -1;
							break;
						case 68: // D - move right
								if(move_axis%2 == 0)
									direction.x = 1;
								else
									direction.z = 1;
							break;
					}
				},false)
				document.addEventListener("keyup",function(e){
					switch(e.which)
					{
						case 39:
							rotateLeft()
							
							break;
						case 37:
							rotateRight();
							break;
						case 65: // A - move left
								if(move_axis%2 == 0)
									direction.x = 0;
								else
									direction.z = 0;
							break;
						case 68: // D - move right
								if(move_axis%2 == 0)
									direction.x = 0;
								else
									direction.z = 0;
							break;
					}
				},false)

				

                function animateScene() {
					player.position.x += direction.x * speed;
					player.position.z += direction.z * speed;
					
					//console.log(GetElementsUnder(scene, player, 0));
					
					if(move_axis==2)
					{
						for(var i=0;i<table.length;i++)
						{
							if((table[i].position.x+25 > player.position.x && table[i].position.x-25 < player.position.x) && (table[i].position.y+25 > player.position.y-10 && table[i].position.y-25 < player.position.y-10))
							{	
								player.position.z = table[i].position.z
							}
						}
					}
					if(move_axis==1)
					{
						for(var i=0;i<table.length;i++)
						{
							if((table[i].position.z+25 > player.position.z &&table[i].position.z-25 < player.position.z) && (table[i].position.y+25 > player.position.y-10 && table[i].position.y-25 < player.position.y-10))
							{	
								player.position.x = table[i].position.x
							}
						}
					}
					if(move_axis==0)
					{
						for(var i=0;i<table.length;i++)
						{
							if((table[i].position.x-25 > player.position.x && table[i].position.x+25 < player.position.x) && (table[i].position.y+25 > player.position.y-10 && table[i].position.y-25 < player.position.y-10))
							{	
								player.position.z = table[i].position.z
							}
						}
					}
					if(move_axis==3)
					{
						for(var i=0;i<table.length;i++)
						{
							if((table[i].position.z-25 > player.position.z &&table[i].position.z+25 < player.position.z) && (table[i].position.y+25 > player.position.y-10 && table[i].position.y-25 < player.position.y-10))
							{	
								player.position.x = table[i].position.x
							}
						}
					}
					
					
                    camera.lookAt(scene.position)
                    requestAnimationFrame(animateScene);
					//var tempZ = camera.position.z * Math.cos(rotation) - camera.position.x * Math.sin(rotation)
                    //var tempX = camera.position.z * Math.sin(rotation) + camera.position.x * Math.cos(rotation)
                    //camera.position.x = tempX;
                    //camera.position.z = tempZ

                    renderer.render(scene, camera);
                }
                animateScene();
            })
    </script>
</head>

<body>
    <div id="controlPanel">
        <div>Kamera Y<input type="range" min="0" max="1000" id="cameraY" /> </div>
        <div> Light Intensity<input type="range" min="0" max="300" id="lightInten" /> </div>
        <div> Camera FOV<input type="range" value="90" min="0" max="105" id="cameraFOV" /> </div>
        <div>Distance Camera Player<input type="range" value="20" min="0" max="105" id="distCam" /> </div>
        <div>Widok z góry<input type="checkbox" checked="checked" id="above" /></div>
        <div>Player Cam <input type="checkbox" id="playerCam" /></div>
    </div>
    <div id="main">

    </div>

</body>

</html>